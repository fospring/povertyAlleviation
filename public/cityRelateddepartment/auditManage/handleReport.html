<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>XX市精准帮扶工程区块链应用系统</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="stylesheet" href="../../../bower_components/bootstrap/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../../bower_components/font-awesome/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="../../../bower_components/Ionicons/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../../dist/css/AdminLTE.css">
  <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
        page. However, you can choose any other skin. Make sure you
        apply the skin class to the body tag so the changes take effect. -->
  <link rel="stylesheet" href="../../../dist/css/skins/skin-blue.min.css">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Google Font -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
  <link rel="stylesheet" href="../../../dist/css/mycss.css">
  <script src="../../../dist/js/myjs.js"></script>
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body class="hold-transition skin-blue sidebar-mini">
<!--Model1-->
<div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">详细情况</h4>
      </div>
      <div class="modal-body">
          <form class="form-horizontal">
          <h4>申报人详情</h4>
            <div class="form-group form-group-sm">
              <label for="username" class="col-sm-2 control-label">申请单号</label>
              <div class="col-sm-3">                
                <p class="form-control-static" id="d_id"></p>
              </div>
            </div>
            <div class="form-group form-group-sm">
              <label for="username" class="col-sm-2 control-label">姓名</label>
              <div class="col-sm-3">                
                <p class="form-control-static" id="dname"></p>
              </div>
              <label for="truename" class="col-sm-2 control-label">身份证号</label>
              <div class="col-sm-3">              
                <p class="form-control-static" id="dIdentID"></p>
              </div>
            </div>
            <div class="form-group form-group-sm">
              <label for="username" class="col-sm-2 control-label">性别</label>
              <div class="col-sm-3">                
                <p class="form-control-static" id="dsex"></p>
              </div>
              <label for="truename" class="col-sm-2 control-label">年龄</label>
              <div class="col-sm-3">              
                <p class="form-control-static" id="dage"></p>
              </div>
            </div>
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">所在区</label>
              <div class="col-sm-3">
                 <p class="form-control-static" id="ddistrict"></p>
              </div>
              <label for="status" class="col-sm-2 control-label">所在县</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dcounty"></p>
              </div>
            </div> 
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">所在乡镇</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dtownship"></p>
              </div>
              <label for="belongs" class="col-sm-2 control-label">所在村</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dviliager"></p>
              </div>
            </div> 
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">家庭人口</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dmemNum"></p>
              </div>
              <label for="status" class="col-sm-2 control-label">家庭人均收入</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dperIncome"></p>
              </div>
            </div> 
            <div class="form-group form-group-sm">
              <label for="status" class="col-sm-2 control-label">贫困等级</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dgrade"></p>
              </div>
            </div>            
            <div class="form-group form-group-sm">
              <label for="status" class="col-sm-2 control-label">情况说明</label>
              <div class="col-sm-8">
                <div class="panel" style="background-color: #efefef;">
                  <div class="panel-body">
                    <span  id="dreason"></span><br>
                    <p class="pull-right">特此被推荐为扶贫对象。<p>
                  </div>
                </div>
              </div>
            </div> 
            <div class="form-group form-group-sm">
              <label for="status" class="col-sm-2 control-label">申请时间</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dcreateAt"></p>
              </div>
            </div> 
            <hr>             
            <h4>举报内容</h4>
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">举报人身份证号</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dtipOffId"></p>
              </div>
              <label for="status" class="col-sm-2 control-label">举报人手机号</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="dphone"></p>
              </div>
            </div>            
            <div class="form-group form-group-sm">
              <label for="status" class="col-sm-2 control-label">情况说明</label>
              <div class="col-sm-8">
                <div class="panel" style="background-color: #efefef;">
                  <div class="panel-body">
                    <span  id="dcomment"></span><br>
                  </div>
                </div>
              </div>
            </div> 
            <hr>  
            <h4>市扶贫办及相关部门处理</h4>  
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">处理人员身份证号</label>
              <div class="col-sm-3">
                <p class="form-control-static" id="cityuserId"></p>
              </div>
            </div>   
            <div class="form-group form-group-sm">
              <label for="belongs" class="col-sm-2 control-label">举报是否有效</label>
              <div class="col-sm-3">                
                 <select class="form-control" name="county" id="cityDicision">
                  <option value="2" selected>举报无效</option>
                  <option value="1">举报有效</option>
                </select>
              </div>
              <label for="belongs" class="col-sm-2 control-label">是否发起调查</label>
              <div class="col-sm-3">                
                 <select class="form-control" name="county" id="investigate">
                  <option value="false" selected>否</option>
                  <option value="true">是</option>
                </select>
              </div>
            </div>   
            <div id="countyReply">  
              <h4>区县扶贫办回复</h4>  
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复人员身份证号</label>
                <div class="col-sm-3">
                  <p class="form-control-static" id="counuserId"></p>
                </div>
              </div>   
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复内容</label>
                <div class="col-sm-8">
                      <div class="panel" style="background-color: #efefef;">
                        <div class="panel-body">
                          <span id="countyComment"></span><br>
                        </div>
                      </div>
                </div>
              </div>               
            </div>   
            <div id="townshipReply">
            <h4>乡镇政府回复</h4>  
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复人员身份证号</label>
                <div class="col-sm-3">
                  <p class="form-control-static" id="towuserid"></p>
                </div>
              </div>   
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复内容</label>
                <div class="col-sm-8">
                    <div class="panel" style="background-color: #efefef;">
                      <div class="panel-body">
                        <span id="townshipComment"></span><br>
                      </div>
                    </div>
                </div>
              </div>               
            </div>  
            <div id="viliagerReply">
              <h4>村民代表大会回复</h4>  
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复人员身份证号</label>
                <div class="col-sm-3">
                  <p class="form-control-static" id="viligerid"></p>
                </div>
              </div>   
              <div class="form-group form-group-sm">
                <label for="belongs" class="col-sm-2 control-label">回复内容</label>
                <div class="col-sm-8">
                  <div class="panel" style="background-color: #efefef;">
                    <div class="panel-body">
                      <span id="viligerComment"></span><br>
                    </div>
                  </div>
                </div>
              </div>                
            </div>          
          </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" onclick="">取消</button>
        <button type="button" class="btn btn-info" data-dismiss="modal" onclick="handle();">提交处理</button>
      </div>
    </div>
  </div>
</div>
<div class="wrapper">

  <!-- Main Header -->
  <header class="main-header">
  </header>
  <!-- Left side column. contains the logo and sidebar -->
  <aside class="main-sidebar">
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        首页
        <small>>举报处理管理</small>
      </h1>
    </section>
    <!-- Main content -->
    <section class="content container-fluid">

      <!--------------------------
        | Your Page Content Here |
        -------------------------->
        <!--coded By Bobo 2017/7/13-->
      <div class="box">    
        <div class="box-body">

<div>
  <!-- Nav tabs -->
  <ul class="nav nav-tabs">
    <li role="presentation" class="active"><a href="#profile" role="tab">举报处理</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active">
      <table class="table table-hover c" id="targetTable">
         <thead>
          <tr>
            <th>被举报人身份证号</th>
            <th>所在区/县/乡/村</th>
            <th>举报人身份证号</th>
            <th>举报人手机号</th>
            <th>举报理由</th>
            <th>所处阶段</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody class="inner"></tbody>
      </table>
    </div>
  </div>

</div>
        </div>
        <!-- /.box-body -->
      </div>
          </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">    
  </footer>
  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Create the tabs -->
    <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
      <li class="active"><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
      <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
      <!-- Settings tab content -->
      <div class="tab-pane" id="control-sidebar-settings-tab">
        <form method="post">
          <h3 class="control-sidebar-heading">General Settings</h3>

          <div class="form-group">
            <label class="control-sidebar-subheading">
              Report panel usage
              <input type="checkbox" class="pull-right" checked>
            </label>

            <p>
              Some information about this general settings option
            </p>
          </div>
          <!-- /.form-group -->
        </form>
      </div>
      <!-- /.tab-pane -->
    </div>
  </aside>
  <!-- /.control-sidebar -->
  <!-- Add the sidebar's background. This div must be placed
  immediately after the control sidebar -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="../../../bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../../../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- AdminLTE App -->
<script src="../../../dist/js/adminlte.js"></script>
<script src="../../../dist/js/myjs.js"></script>
<script src="../../../dist/js/moment.js"></script>
<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->
  <script>
  /*
   *加载header、sider和footer
  */
    $(".main-header").load("../mainheader.html"); 
    $(".main-sidebar").load("../mainsider.html");
    $(".main-footer").load("../../mainfooter.html"); 
/*
*
*/
$(document).ready(function(){
  $("#cityuserId").html(getCookie("cityuserId"))
  var postBody = {
      district: getCookie("district"),
      role:getCookie("citrole")
  };
  $.ajax({
      type: 'POST',
      url: 'http://localhost:3000/patest/showtipoffs',
      data: postBody,
      dataType: 'json',
      success: function(data){        
          var jsonstr=JSON.stringify(data);
          console.log(jsonstr); 
          var str;
          for(var o in data){
            if(data[o].stage =="2"&&data[o].handle=="2"){     
              str ="第二次公示期间";         
              $('<tr>'
              +'<td style="display:none;" id="id'+o+'">'+data[o].id+'</td>'
              +'<td style="display:none;" id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td style="display:none;" id="_id'+o+'">'+data[o]._id+'</td>'
              +'<td style="display:none;" id="appId'+o+'">'+data[o].appId+'</td>'
              +'<td style="display:none;" id="stage'+o+'">'+data[o].stage+'</td>'
              +'<td style="display:none;" id="thisAdmin'+o+'">'+data[o].thisAdmin+'</td>'
              +'<td style="display:none;" id="thisAdminComment'+o+'">'+data[o].thisAdminComment+'</td>'
              +'<td style="display:none;" id="upperAdmin'+o+'">'+data[o].upperAdmin+'</td>'
              +'<td style="display:none;" id="upperAdminComment'+o+'">'+data[o].upperAdminComment+'</td>'
              +'<td id="id'+o+'">'+data[o].id+'</td>'
              +'<td>'+data[o].district+"/"+data[o].county+"/"+data[o].township+data[o].viliager+'</td>'
              +'<td id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td id="phone'+o+'">'+data[o].phone+'</td>'
              +'<td id="comment'+o+'">'+data[o].comment+'</td>'
              +'<td>'+str+'</td>'
              +'<td><span id="send'+o+'"><a class="btn btn-info" id="'+o+'" data-toggle="modal" data-target="#myModal" onclick="viewdetails(this)">查看详情及处理</a></sapn></td>'
             +'</tr>').appendTo(".inner");
            }else if(data[o].stage =="3"&&data[o].handle=="1"){      
              str ="公告期间";              
              $('<tr>'
              +'<td style="display:none;" id="id'+o+'">'+data[o].id+'</td>'
              +'<td style="display:none;" id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td style="display:none;" id="thisAdmin'+o+'">'+data[o].thisAdmin+'</td>'
              +'<td style="display:none;" id="thisAdminComment'+o+'">'+data[o].thisAdminComment+'</td>'
              +'<td style="display:none;" id="_id'+o+'">'+data[o]._id+'</td>'
              +'<td style="display:none;" id="appId'+o+'">'+data[o].appId+'</td>'
              +'<td style="display:none;" id="stage'+o+'">'+data[o].stage+'</td>'
              +'<td id="id'+o+'">'+data[o].id+'</td>'
              +'<td>'+data[o].district+"/"+data[o].county+"/"+data[o].township+data[o].viliager+'</td>'
              +'<td id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td id="phone'+o+'">'+data[o].phone+'</td>'
              +'<td id="comment'+o+'">'+data[o].comment+'</td>'
              +'<td>'+str+'</td>'
              +'<td><span id="send'+o+'"><a class="btn btn-info" id="'+o+'" data-toggle="modal" data-target="#myModal" onclick="viewdetails(this)">查看详情及处理</a></sapn></td>'
             +'</tr>').appendTo(".inner");
            }else if(data[o].stage =="1"&&data[o].handle=="2"){      
              str ="第一次公示期间";              
              $('<tr>'
              +'<td style="display:none;" id="id'+o+'">'+data[o].id+'</td>'
              +'<td style="display:none;" id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td style="display:none;" id="_id'+o+'">'+data[o]._id+'</td>'
              +'<td style="display:none;" id="appId'+o+'">'+data[o].appId+'</td>'
              +'<td style="display:none;" id="stage'+o+'">'+data[o].stage+'</td>'
              +'<td style="display:none;" id="thisAdmin'+o+'">'+data[o].thisAdmin+'</td>'
              +'<td style="display:none;" id="thisAdminComment'+o+'">'+data[o].thisAdminComment+'</td>'
              +'<td style="display:none;" id="upperAdmin'+o+'">'+data[o].upperAdmin+'</td>'
              +'<td style="display:none;" id="upperAdminComment'+o+'">'+data[o].upperAdminComment+'</td>'
              +'<td id="id'+o+'">'+data[o].id+'</td>'
              +'<td>'+data[o].district+"/"+data[o].county+"/"+data[o].township+data[o].viliager+'</td>'
              +'<td id="tipOffId'+o+'">'+data[o].tipOffId+'</td>'
              +'<td id="phone'+o+'">'+data[o].phone+'</td>'
              +'<td id="comment'+o+'">'+data[o].comment+'</td>'
              +'<td>'+str+'</td>'
              +'<td><span id="send'+o+'"><a class="btn btn-info" id="'+o+'" data-toggle="modal" data-target="#myModal" onclick="viewdetails(this)">查看详情及处理</a></sapn></td>'
             +'</tr>').appendTo(".inner");
            }
          }
          if($(".inner").html()==""){
            $(".inner").html('<span style="color:#3c8dbc;">暂无需要处理的举报。</span>');
          }
      }
  }).error(function(err){
      console.log(err);
      alert("错误："+err.responseText);
  });

});

  function viewdetails(obj){
    var gradeobj = "#grade"+obj.id;
    var grade = $(gradeobj).val();
        var num=obj.id;//num=0
        addCookie("number",num,1);
        var appId="#appId"+num;
        var tipOffId="#tipOffId"+num;
        var phone = "#phone"+num;
        var comment = "#comment"+num;   
        $("#dtipOffId").text($(tipOffId).text());
        $("#dphone").text($(phone).text());
        $("#dcomment").text($(comment).text());
        var postBody = {
            _id:$(appId).html()
            };
        $.ajax({
            type: 'POST',
            url: 'http://localhost:3000/patest/findById',
            data: postBody,
            dataType: 'json',
            success: function(data){ 
              $("#d_id").text(data._id);
              $("#dIdentID").text(data.IdentID);
              $("#dname").text(data.name);
              $("#dage").text(data.age);
              $("#dsex").text(data.sex);
              $("#dmemNum").text(data.memNum);
              $("#ddistrict").text(data.district);
              $("#dcounty").text(data.county);
              $("#dtownship").text(data.township);
              $("#dviliager").text(data.viliager);
              $("#dperIncome").text(data.perIncome);
              $("#dlabourNum").text(data.labourNum);
              $("#dreason").text(data.reason);
              $("#dgrade").text(data.grade);
              $("#dcreateAt").text(moment(data.createAt).format('YYYY-MM-DD'));
              //alert(data.labourNum+data.grade)
              var num=getCookie("number");
              var stage = "#stage"+num;
              var thisAdmin = "#thisAdmin" +num;
              var thisAdminComment = "#thisAdminComment"+num; 
              var upperAdmin = "#upperAdmin" +num;
              var upperAdminComment = "#upperAdminComment"+num; 
              $("#viliagerReply").hide();                
              $("#townshipReply").hide();
              $("#countyReply").hide();
              if($(stage).text()=="2"){               
                $("#townshipReply").show();
                $("#countyReply").show();
                $("#towuserid").html($(thisAdmin).text());
                $("#townshipComment").html($(thisAdminComment).text());
                $("#counuserId").html($(upperAdmin).text());
                $("#countyComment").html($(upperAdminComment).text());
              }else if($(stage).text()=="3"){                
                $("#countyReply").show();
                $("#counuserId").html($(thisAdmin).text());
                $("#countyComment").html($(thisAdminComment).text());
              }else if($(stage).text()=="1"){             
                $("#townshipReply").show();
                $("#viliagerReply").show();
                $("#viligerid").html($(thisAdmin).text());
                $("#viligerComment").html($(thisAdminComment).text());
                $("#towuserid").html($(upperAdmin).text());
                $("#townshipComment").html($(upperAdminComment).text());
              }
            }
         }).error(function(err){
            console.log(err);
            alert("服务器忙！请稍后再尝试");
          });
      }

  function handle(){
         var num= getCookie("number");
         var pager='#send'+num+'';
         var str2;
         if($("#cityDicision").val()=="1"){
           if($("#investigate").val()=="true"){
            str="举报有效，发起调查";
           }else{
            str="举报有效，不发起调查";
           }
         }else{
          if($("#investigate").val()=="true"){
            str="举报无效,发起调查";
          }else{
            str="举报无效,不发起调查";
          }
         }
          alert(str);
         $(pager).replaceWith('<span style="color:#d73925;">'+str+'</span>');
        var _rid="#_id"+num;
        var stage = "#stage"+num;    
        var id="#id"+num;
        var tipOffId = "#tipOffId"+num;  
        var postBody = {
            _id:$(_rid).html(),
            role:getCookie("citrole"),
            stage:$(stage).html(),
            cityAdmin:getCookie("cityuserId"),
            cityDicision:$("#cityDicision").val(),
            investigate:$("#investigate").val(),
            tipOffId:$(tipOffId).html(),
            id:$(id).html()
            };
        alert(JSON.stringify(postBody))
        $.ajax({
            type: 'POST',
            url: 'http://localhost:3000/patest/report/comment',
            data: postBody,
            dataType: 'json',
            success: function(data){  
            }
         }).error(function(err){
            console.log(err);
            alert("服务器忙！请稍后再尝试");
          });
      }
  </script>
</body>
</html>